<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Holiday Mixer ‚Äî Slot Machine (◊ë◊¥◊î + prototype media)</title>
<style>
  :root{
    --bg:#080d22; --ink:#f7fbff; --muted:#c7d4ff; --rim:#2a3570; --gold:#ffd54f; --good:#29e3a2;
    --r1a:#0e5ce6; --r1b:#7ac3ff; --r2a:#7b2fe0; --r2b:#f3a9ff; --r3a:#0ea66c; --r3b:#aef7d0;
    --r4a:#ffb703; --r4b:#ffe9a8; --r5a:#ff6a00; --r5b:#ffb38a;
  }
  *{box-sizing:border-box}
  body{margin:0; background:radial-gradient(1600px 1200px at 50% -20%, #2a3570 0%, var(--bg) 60%);
       color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial; font-size:18px;}
  header{padding:26px 16px; text-align:center; position:relative}
  h1{margin:0 0 10px; font-size:40px; letter-spacing:.2px}
  .note{color:var(--muted); font-size:18px}
  .lang{position:absolute; top:12px; right:16px; display:flex; gap:10px}
  .lang button{cursor:pointer; border:0; border-radius:12px; padding:10px 16px; font-weight:900; font-size:18px; background:#202a57; color:#d7e5ff}
  .lang .on{background:linear-gradient(180deg,#15a9ff,#0675ce); color:#fff}

  /* NEW: B"H badge */
  .bhe{position:absolute; top:10px; left:16px; font-weight:900; font-size:22px; color:#ffe07a;
       text-shadow:0 1px 1px rgba(0,0,0,.8); letter-spacing:.5px; user-select:none}
  .bhe small{display:block; font-size:12px; color:#ffd54f; opacity:.85}

  .wrap{max-width:1500px; margin:0 auto; padding:12px 16px 90px}
  .board{background:linear-gradient(180deg,#0f163d,#0a102c); border:1px solid var(--rim); border-radius:22px;
         padding:20px; box-shadow:0 30px 80px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.05)}

  .actions{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:14px}
  .btn{cursor:pointer; border:0; border-radius:14px; padding:14px 18px; font-weight:900; font-size:18px}
  .btn-primary{background:linear-gradient(180deg,#15a9ff,#0675ce); color:#fff}
  .btn-ghost{background:#202a57; color:#d7e5ff}

  .lever{margin-left:auto; display:flex; align-items:center; gap:10px}
  .stick{width:12px; height:70px; background:#aaa; border-radius:6px; position:relative}
  .knob{width:34px; height:34px; background:var(--gold); border-radius:50%; position:relative; top:-8px; left:-10px;
        box-shadow:0 4px 10px rgba(0,0,0,.6); cursor:pointer}

  .headerlights{height:12px; border-radius:8px; margin:10px 0 12px;
    background:linear-gradient(90deg,#ff5f5f,#ffd54f,#6dff6d,#6fd3ff,#b58cff,#ff5f5f);
    background-size:300% 100%; animation:lights 6s linear infinite; opacity:.75}
  .machine{position:relative; display:grid; grid-template-columns:repeat(5,1fr); gap:18px; align-items:stretch;
           border:2px solid #c8a23a; border-radius:18px; padding:16px; background:linear-gradient(180deg,#1a2149,#0b1130)}
  .machine.win{box-shadow:0 0 0 6px rgba(255,213,79,.7), 0 0 40px 14px rgba(255,213,79,.45); animation:glow 1s ease-in-out 9;}
  @keyframes lights{0%{background-position:0 0}100%{background-position:300% 0}}
  @keyframes glow{0%,100%{filter:brightness(1)}50%{filter:brightness(1.25)}}

  .reel{border-radius:16px; padding:14px; position:relative; box-shadow:inset 0 0 28px rgba(0,0,0,.38);
        border:1px solid rgba(255,255,255,.1)}
  .reel[data-i="0"]{background:linear-gradient(180deg,var(--r1a),var(--r1b))}
  .reel[data-i="1"]{background:linear-gradient(180deg,var(--r2a),var(--r2b))}
  .reel[data-i="2"]{background:linear-gradient(180deg,var(--r3a),var(--r3b))}
  .reel[data-i="3"]{background:linear-gradient(180deg,var(--r4a),var(--r4b))}
  .reel[data-i="4"]{background:linear-gradient(180deg,var(--r5a),var(--r5b))}
  .chrome{position:absolute; inset:0; border-radius:16px; padding:8px; pointer-events:none;}
  .chrome:before{content:""; position:absolute; inset:0; border-radius:16px; border:2px solid rgba(255,255,255,.5);
                 box-shadow:inset 0 0 14px rgba(255,255,255,.35), inset 0 0 34px rgba(255,255,255,.18)}

  .title{font-size:18px; letter-spacing:.4px; color:#0b1030; text-shadow:0 1px 1px rgba(255,255,255,.7);
         margin-bottom:10px; font-weight:900; display:flex; align-items:center; gap:8px}
  .title .ico{font-size:20px}

  .window{position:relative; height:210px; overflow:hidden; border-radius:14px; background:rgba(10,16,39,.25);
          border:2px solid rgba(255,255,255,.7); backdrop-filter: blur(1px)}
  .window.stop{animation:stopPulse .28s ease;}
  @keyframes stopPulse{0%{box-shadow:0 0 0 0 rgba(255,255,255,.0)}100%{box-shadow:0 0 0 10px rgba(255,255,255,.0)}}

  .payline{position:absolute; left:0; right:0; top:70px; height:70px;
           border-top:2px dashed #fff; border-bottom:2px dashed #fff;
           box-shadow:0 0 12px rgba(255,255,255,.5) inset; pointer-events:none; transition:box-shadow .25s}
  .payline.almost{box-shadow:0 0 18px rgba(255,213,79,.9) inset, 0 0 12px rgba(255,213,79,.6) inset}

  .strip{list-style:none; padding:0; margin:0; transition: transform .55s cubic-bezier(.2,.8,.2,1)}
  .cell{height:70px; display:flex; align-items:center; justify-content:center; padding:0 12px; text-align:center;
        font-weight:800; font-size:20px; line-height:1.15; color:#0a1130; text-shadow:0 1px 0 rgba(255,255,255,.6);
        cursor:pointer; user-select:none; background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.56))}
  .cell:nth-child(odd){background:linear-gradient(180deg,rgba(255,255,255,.97),rgba(255,255,255,.65))}
  .controls{display:flex; gap:8px; margin-top:10px}
  .btn-mini{cursor:pointer; border:0; border-radius:12px; padding:10px 12px; font-weight:900; font-size:18px; background:rgba(0,0,0,.22); color:#0b1030; border:1px solid rgba(255,255,255,.6)}

  .status{margin-top:12px; min-height:30px; font-size:22px}
  .success{ color:var(--good) }

  .win-banner{position:fixed; left:50%; top:12%; transform:translateX(-50%) scale(.95);
              background:linear-gradient(180deg,#fff7c2,#ffe37a); border:4px solid #e8b700; color:#5a4100; font-weight:900;
              padding:16px 22px; border-radius:16px; font-size:34px; box-shadow:0 14px 40px rgba(0,0,0,.35);
              display:none; z-index:2000; animation:pop .6s ease}
  .win-banner.show{display:block}
  @keyframes pop{0%{transform:translateX(-50%) scale(.6); opacity:0} 100%{transform:translateX(-50%) scale(.95); opacity:1}}
  .confetti{position:fixed; top:-2vh; width:9px; height:14px; border-radius:2px; z-index:1999}

  .info{margin-top:18px; background:linear-gradient(180deg,#0e1536,#0a102a); border:1px solid var(--rim); border-radius:16px; padding:18px;
        box-shadow:inset 0 0 24px rgba(0,0,0,.35)}
  .info h3{margin:0 0 12px; font-size:26px}
  .grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:14px}
  .card{background:#0c122e; border:1px solid #2b3569; border-radius:12px; padding:14px}
  .card h4{margin:0 0 8px; font-size:16px; color:#bcd1ff; letter-spacing:.4px}
  .card .v{font-weight:800; font-size:20px}

  /* Media preview cards */
  .media{display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:12px; margin-top:12px}
  .poster{width:100%; height:160px; border-radius:10px; border:1px solid #2b3569; background:#0a1130; object-fit:cover}
  .anim{height:160px; display:grid; place-items:center; border-radius:10px; border:1px solid #2b3569; background:#0a1130; font-size:64px}
  .bounce{animation:bounce 1.2s infinite}
  @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
  .play{cursor:pointer; border:0; border-radius:10px; padding:10px 14px; font-weight:900; background:#1b2348; color:#d7e5ff; border:1px solid #2b3569}

  [dir="rtl"] .machine{direction:rtl}
  [dir="rtl"] .title, [dir="rtl"] .cell, [dir="rtl"] .note {text-align:right}
</style>
</head>
<body>
<header>
  <div class="bhe">◊ë◊¥◊î<small>B‚Äôezrat Hashem</small></div>
  <div class="lang">
    <button id="lang-en" class="on">English</button>
    <button id="lang-he">‚Äè◊¢◊ë◊®◊ô◊™</button>
  </div>
  <h1 id="title">Holiday Mixer ‚Äî Slot Machine</h1>
  <div class="note" id="subtitle">Click a cell to snap that reel to the center. Or spin reels. Align all five center cells to the same holiday.</div>
</header>

<div class="wrap">
  <div class="board">
    <div class="actions">
      <button class="btn btn-primary" id="btn-spin-all">üé∞ <span data-i18n="spinAll">Spin All</span></button>
      <button class="btn btn-ghost" id="btn-new" data-i18n="newRound">New Round</button>
      <button class="btn btn-ghost" id="btn-hint">Hint: OFF</button>
      <div class="lever" title="Spin All">
        <div class="stick"></div><div class="knob" id="lever"></div>
      </div>
    </div>

    <div class="headerlights"></div>
    <div class="machine" id="machine"></div>
    <div class="status" id="status"></div>

    <div class="info" id="info" style="display:none">
      <h3 id="info-title">Holiday</h3>
      <div class="grid">
        <div class="card"><h4 id="lbl-story">Story</h4><div class="v" id="i-story">‚Äî</div></div>
        <div class="card"><h4 id="lbl-food">Food</h4><div class="v" id="i-food">‚Äî</div></div>
        <div class="card"><h4 id="lbl-season">Season</h4><div class="v" id="i-season">‚Äî</div></div>
        <div class="card"><h4 id="lbl-symbol">Symbol</h4><div class="v" id="i-symbol">‚Äî</div></div>
      </div>

      <!-- NEW: prototype media section -->
      <div class="media">
        <div class="card">
          <h4 id="lbl-poster">Image</h4>
          <img id="poster" class="poster" alt="Poster"/>
        </div>
        <div class="card">
          <h4 id="lbl-anim">‚ÄúVideo‚Äù</h4>
          <div id="anim" class="anim">üéâ</div>
        </div>
        <div class="card">
          <h4 id="lbl-audio">Song / Tune</h4>
          <button class="play" id="btn-play">‚ñ∂Ô∏é Play</button>
          <button class="play" id="btn-stop" style="margin-left:8px">‚ñ† Stop</button>
        </div>
      </div>

      <div style="margin-top:10px; color:#bcd1ff" id="coming">
        Coming soon: real photos, videos, songs, and ‚ÄúAsk about this holiday‚Äù.
      </div>
    </div>
  </div>
</div>

<div class="win-banner" id="win-banner">üéâ YOU WIN! üéâ</div>

<script>
(function(){
  /* Data (ENG+HE) */
  const DATA = {
    en:{ ui:{
        title:"Holiday Mixer ‚Äî Slot Machine",
        subtitle:"Click a cell to snap that reel to the center. Or spin reels. Align all five center cells to the same holiday.",
        spinAll:"Spin All", newRound:"New Round",
        cols:{name:"Name", story:"Story", food:"Food", season:"Season", symbol:"Symbol"},
        coming:"Coming soon: real photos, videos, songs, and ‚ÄúAsk about this holiday‚Äù.",
        win:(n)=>`üéâ You Win! It‚Äôs ${n}`, hintOff:"Hint: OFF", hintOn:"Hint: ON", looks:"Looks good!",
        icons:{name:"üïØÔ∏è",story:"üìñ",food:"ü•ô",season:"üçÇ",symbol:"‚ú°Ô∏è"},
        media:{image:"Image",video:"‚ÄúVideo‚Äù",audio:"Song / Tune"},
      },
      holidays:{
        roshhashanah:{key:"roshhashanah",name:"Rosh Hashanah",story:"Jewish New Year; introspection and renewal",food:"Apples & honey; pomegranate",season:"Autumn ‚Ä¢ Tishrei (early)",symbol:"Shofar (ram's horn)",emoji:"üìØüçéüçØ",color:"#6aa9ff"},
        yomkippur:{key:"yomkippur",name:"Yom Kippur",story:"Day of Atonement; fasting & prayer",food:"(Fast day) ‚Äì pre/post fast meals",season:"Autumn ‚Ä¢ Tishrei (mid)",symbol:"White clothing; machzor",emoji:"ü§çüìñ",color:"#b0c4ff"},
        sukkot:{key:"sukkot",name:"Sukkot",story:"Festival of Booths; dwelling in sukkah",food:"Harvest meals in the sukkah",season:"Autumn ‚Ä¢ Tishrei (mid‚Äëlate)",symbol:"Lulav & etrog",emoji:"üåøüçãüèïÔ∏è",color:"#79e0a7"},
        simchattorah:{key:"simchattorah",name:"Simchat Torah",story:"Completion & restart of Torah reading",food:"Dancing sweets; kiddush treats",season:"Autumn ‚Ä¢ Tishrei (late)",symbol:"Dancing with Torah scrolls",emoji:"üìúüï∫",color:"#caa6ff"},
        hanukkah:{key:"hanukkah",name:"Hanukkah",story:"Maccabees & the oil that lasted eight days",food:"Latkes; sufganiyot",season:"Early winter ‚Ä¢ Kislev",symbol:"Menorah/Chanukiah, dreidel",emoji:"üïéü´ìüç©",color:"#ffd26a"},
        purim:{key:"purim",name:"Purim",story:"Esther & Mordechai foil Haman's plot",food:"Hamantaschen",season:"Late winter ‚Ä¢ Adar",symbol:"Megillah & grogger",emoji:"üé≠üìú",color:"#ff9ad6"},
        pesach:{key:"pesach",name:"Pesach (Passover)",story:"Exodus from Egypt; freedom from slavery",food:"Matzah, maror, charoset",season:"Spring ‚Ä¢ Nisan",symbol:"Seder plate / three matzot",emoji:"üç∑ü´ìüçΩÔ∏è",color:"#9fe0ff"},
        shavuot:{key:"shavuot",name:"Shavuot",story:"Giving of the Torah at Sinai",food:"Cheesecake & dairy dishes",season:"Early summer ‚Ä¢ Sivan",symbol:"Tablets / Torah scroll",emoji:"üìú‚õ∞Ô∏èüßÄ",color:"#a7ffcc"}
      }
    },
    he:{ ui:{
        title:"◊û◊¢◊®◊ë◊ú ◊î◊ó◊í◊ô◊ù ‚Äî ◊û◊õ◊ï◊†◊™ ◊û◊ñ◊ú",
        subtitle:"◊ú◊ó◊¶◊ï ◊¢◊ú ◊©◊ï◊®◊î ◊õ◊ì◊ô ◊ú◊ô◊ô◊©◊® ◊ê◊ï◊™◊î ◊ú◊û◊®◊õ◊ñ. ◊ê◊§◊©◊® ◊í◊ù ◊ú◊°◊ï◊ë◊ë ◊í◊ú◊í◊ú◊ô◊ù. ◊î◊™◊ê◊ô◊û◊ï ◊ê◊™ ◊õ◊ú ◊ó◊û◊©◊™ ◊î◊©◊ï◊®◊ï◊™ ◊ú◊ó◊í ◊ê◊ó◊ì.",
        spinAll:"◊°◊ï◊ë◊ë ◊î◊õ◊ú", newRound:"◊°◊ë◊ë ◊ó◊ì◊©",
        cols:{name:"◊©◊ù ◊î◊ó◊í", story:"◊°◊ô◊§◊ï◊®", food:"◊û◊ê◊õ◊ú", season:"◊¢◊ï◊†◊î", symbol:"◊°◊û◊ú"},
        coming:"◊ë◊ß◊®◊ï◊ë: ◊™◊û◊ï◊†◊ï◊™ ◊ê◊û◊ô◊™◊ô◊ï◊™, ◊°◊®◊ò◊ï◊†◊ô◊ù, ◊©◊ô◊®◊ô◊ù, ◊ï◊õ◊§◊™◊ï◊® ‚Äû◊©◊ê◊ú ◊¢◊ú ◊î◊ó◊í‚Äù.",
        win:(n)=>`üéâ ◊†◊ô◊¶◊ó◊™◊ù! ◊ñ◊î ${n}`, hintOff:"◊®◊û◊ñ: ◊õ◊ë◊ï◊ô", hintOn:"◊®◊û◊ñ: ◊§◊ï◊¢◊ú", looks:"◊§◊ô◊ß◊°!",
        icons:{name:"üïØÔ∏è",story:"üìñ",food:"ü•ô",season:"üçÇ",symbol:"‚ú°Ô∏è"},
        media:{image:"◊™◊û◊ï◊†◊î",video:"‚Äû◊ï◊ô◊ì◊ê◊ï‚Äù",audio:"◊û◊†◊í◊ô◊†◊î"}
      },
      holidays:{
        roshhashanah:{key:"roshhashanah",name:"◊®◊ê◊© ◊î◊©◊†◊î",story:"◊®◊ê◊© ◊î◊©◊†◊î; ◊ó◊©◊ë◊ï◊ü ◊†◊§◊© ◊ï◊î◊™◊ó◊ì◊©◊ï◊™",food:"◊™◊§◊ï◊ó ◊ï◊ì◊ë◊©; ◊®◊ô◊û◊ï◊ü",season:"◊°◊™◊ô◊ï ‚Ä¢ ◊™◊©◊®◊ô (◊™◊ó◊ô◊ú◊™ ◊™◊©◊®◊ô)",symbol:"◊©◊ï◊§◊®",emoji:"üìØüçéüçØ",color:"#6aa9ff"},
        yomkippur:{key:"yomkippur",name:"◊ô◊ï◊ù ◊õ◊ô◊§◊ï◊®",story:"◊ô◊ï◊ù ◊î◊õ◊ô◊§◊ï◊®◊ô◊ù; ◊¶◊ï◊ù ◊ï◊™◊§◊ô◊ú◊î",food:"(◊ô◊ï◊ù ◊¶◊ï◊ù) ‚Äî ◊ê◊®◊ï◊ó◊ï◊™ ◊ú◊§◊†◊ô/◊ê◊ó◊®◊ô",season:"◊°◊™◊ô◊ï ‚Ä¢ ◊™◊©◊®◊ô (◊ê◊û◊¶◊¢ ◊™◊©◊®◊ô)",symbol:"◊ë◊í◊ì◊ô◊ù ◊ú◊ë◊†◊ô◊ù; ◊û◊ó◊ñ◊ï◊®",emoji:"ü§çüìñ",color:"#b0c4ff"},
        sukkot:{key:"sukkot",name:"◊°◊ï◊õ◊ï◊™",story:"◊ó◊í ◊î◊°◊ï◊õ◊ï◊™; ◊ô◊©◊ô◊ë◊î ◊ë◊°◊ï◊õ◊î",food:"◊°◊¢◊ï◊ì◊ï◊™ ◊ß◊¶◊ô◊® ◊ë◊°◊ï◊õ◊î",season:"◊°◊™◊ô◊ï ‚Ä¢ ◊™◊©◊®◊ô (◊ê◊û◊¶◊¢÷æ◊°◊ï◊£)",symbol:"◊ú◊ï◊ú◊ë ◊ï◊ê◊™◊®◊ï◊í",emoji:"üåøüçãüèïÔ∏è",color:"#79e0a7"},
        simchattorah:{key:"simchattorah",name:"◊©◊û◊ó◊™ ◊™◊ï◊®◊î",story:"◊°◊ô◊ï◊ù ◊ï◊§◊™◊ô◊ó◊î ◊û◊ó◊ì◊© ◊©◊ú ◊ß◊®◊ô◊ê◊™ ◊î◊™◊ï◊®◊î",food:"◊û◊û◊™◊ß◊ô◊ù ◊ë◊®◊ô◊ß◊ï◊ì◊ô◊ù; ◊ß◊ô◊ì◊ï◊©",season:"◊°◊™◊ô◊ï ‚Ä¢ ◊™◊©◊®◊ô (◊°◊ï◊£ ◊™◊©◊®◊ô)",symbol:"◊®◊ô◊ß◊ï◊ì ◊¢◊ù ◊°◊§◊®◊ô ◊™◊ï◊®◊î",emoji:"üìúüï∫",color:"#caa6ff"},
        hanukkah:{key:"hanukkah",name:"◊ó◊†◊ï◊õ◊î",story:"◊î◊ó◊©◊û◊ï◊†◊ê◊ô◊ù ◊ï◊§◊ö ◊î◊©◊û◊ü ◊ú◊©◊û◊ï◊†◊î ◊ô◊û◊ô◊ù",food:"◊ú◊ë◊ô◊ë◊ï◊™; ◊°◊ï◊§◊í◊†◊ô◊ï◊™",season:"◊™◊ó◊ô◊ú◊™ ◊ó◊ï◊®◊£ ‚Ä¢ ◊õ◊°◊ú◊ï",symbol:"◊ó◊†◊ï◊õ◊ô◊ô◊î/◊û◊†◊ï◊®◊î; ◊°◊ë◊ô◊ë◊ï◊ü",emoji:"üïéü´ìüç©",color:"#ffd26a"},
        purim:{key:"purim",name:"◊§◊ï◊®◊ô◊ù",story:"◊ê◊°◊™◊® ◊ï◊û◊®◊ì◊õ◊ô ◊û◊°◊õ◊ú◊ô◊ù ◊ê◊™ ◊î◊û◊ü",food:"◊ê◊ï◊ñ◊†◊ô ◊î◊û◊ü",season:"◊°◊ï◊£ ◊ó◊ï◊®◊£ ‚Ä¢ ◊ê◊ì◊®",symbol:"◊û◊í◊ô◊ú◊î ◊ï◊®◊¢◊©◊ü",emoji:"üé≠üìú",color:"#ff9ad6"},
        pesach:{key:"pesach",name:"◊§◊°◊ó",story:"◊ô◊¶◊ô◊ê◊™ ◊û◊¶◊®◊ô◊ù; ◊ó◊ô◊®◊ï◊™ ◊û◊¢◊ë◊ì◊ï◊™",food:"◊û◊¶◊î, ◊û◊®◊ï◊®, ◊ó◊®◊ï◊°◊™",season:"◊ê◊ë◊ô◊ë ‚Ä¢ ◊†◊ô◊°◊ü",symbol:"◊ß◊¢◊®◊™ ◊°◊ì◊® / ◊©◊ú◊ï◊© ◊û◊¶◊ï◊™",emoji:"üç∑ü´ìüçΩÔ∏è",color:"#9fe0ff"},
        shavuot:{key:"shavuot",name:"◊©◊ë◊ï◊¢◊ï◊™",story:"◊û◊™◊ü ◊™◊ï◊®◊î ◊ë◊î◊® ◊°◊ô◊†◊ô",food:"◊¢◊ï◊í◊™ ◊í◊ë◊ô◊†◊î ◊ï◊û◊ê◊õ◊ú◊ô ◊ó◊ú◊ë",season:"◊™◊ó◊ô◊ú◊™ ◊ß◊ô◊• ‚Ä¢ ◊°◊ô◊ï◊ü",symbol:"◊ú◊ï◊ó◊ï◊™ / ◊°◊§◊® ◊™◊ï◊®◊î",emoji:"üìú‚õ∞Ô∏èüßÄ",color:"#a7ffcc"}
      }
    }
  };

  const ROW_H=70, CENTER_ROW=1, CELEBRATION_MS=9000, CONFETTI_COUNT=300;
  let LANG='en', hintOn=false, reels=[];
  const machine = document.getElementById('machine');
  const statusEl= document.getElementById('status');
  const hintBtn = document.getElementById('btn-hint');
  const infoBox = document.getElementById('info');
  const winBanner = document.getElementById('win-banner');
  const posterImg = document.getElementById('poster');
  const animBox   = document.getElementById('anim');
  const btnPlay   = document.getElementById('btn-play');
  const btnStop   = document.getElementById('btn-stop');

  let audioCtx=null, currentNodes=[];

  function t(){ return DATA[LANG]; }
  function H(){ return t().holidays; }

  function build(){
    document.getElementById('title').textContent = t().ui.title;
    document.getElementById('subtitle').textContent = t().ui.subtitle;
    document.querySelector('[data-i18n="spinAll"]').textContent = t().ui.spinAll;
    document.getElementById('btn-new').textContent = t().ui.newRound;
    document.getElementById('lbl-story').textContent = t().ui.cols.story;
    document.getElementById('lbl-food').textContent = t().ui.cols.food;
    document.getElementById('lbl-season').textContent = t().ui.cols.season;
    document.getElementById('lbl-symbol').textContent = t().ui.cols.symbol;
    document.getElementById('lbl-poster').textContent = t().ui.media.image;
    document.getElementById('lbl-anim').textContent = t().ui.media.video;
    document.getElementById('lbl-audio').textContent = t().ui.media.audio;
    document.getElementById('coming').textContent = t().ui.coming;

    document.documentElement.lang = (LANG==='he'?'he':'en');
    document.documentElement.dir  = (LANG==='he'?'rtl':'ltr');
    document.getElementById('lang-en').classList.toggle('on', LANG==='en');
    document.getElementById('lang-he').classList.toggle('on', LANG==='he');

    reels=[]; machine.innerHTML="";
    const CATS = [
      {id:"name",   label:`${t().ui.icons.name} ${t().ui.cols.name}`,   get:(h)=>h.name},
      {id:"story",  label:`${t().ui.icons.story} ${t().ui.cols.story}`, get:(h)=>h.story},
      {id:"food",   label:`${t().ui.icons.food} ${t().ui.cols.food}`,   get:(h)=>h.food},
      {id:"season", label:`${t().ui.icons.season} ${t().ui.cols.season}`,get:(h)=>h.season},
      {id:"symbol", label:`${t().ui.icons.symbol} ${t().ui.cols.symbol}`,get:(h)=>h.symbol}
    ];

    CATS.forEach((cat,i)=>{
      const reel=document.createElement('div');
      reel.className='reel'; reel.dataset.i=i;
      const topChrome=document.createElement('div'); topChrome.className='chrome';
      const title=document.createElement('div'); title.className='title'; title.innerHTML = `<span class="ico"></span> ${cat.label}`;
      const win=document.createElement('div'); win.className='window';
      const payline=document.createElement('div'); payline.className='payline';
      const strip=document.createElement('ul'); strip.className='strip';
      win.appendChild(strip); win.appendChild(payline);
      reel.appendChild(topChrome); reel.appendChild(title); reel.appendChild(win);

      const ctrls=document.createElement('div'); ctrls.className='controls';
      const spinBtn=mini('Spin'), upBtn=mini('‚ñ≤'), downBtn=mini('‚ñº');
      ctrls.append(spinBtn,upBtn,downBtn); reel.appendChild(ctrls);
      machine.appendChild(reel);

      const baseItems = Object.values(H()).map(h=>({key:h.key, text:cat.get(h)}));
      shuffle(baseItems);
      const obj={cat, items:baseItems, loop:null, index:baseItems.length, strip, payline, windowEl:win};
      const loop=[...baseItems, ...baseItems, ...baseItems];
      loop.forEach((it, idx)=>{ const li=document.createElement('li'); li.className='cell'; li.textContent=it.text; li.onclick=()=>snapToIndex(obj, idx); strip.appendChild(li); });
      obj.loop=loop; reels.push(obj);

      spinBtn.onclick=()=>spin(obj);
      upBtn.onclick=()=>nudge(obj,-1);
      downBtn.onclick=()=>nudge(obj, 1);
    });

    applyAll(false);
    statusEl.textContent=""; statusEl.className="status";
    infoBox.style.display="none"; winBanner.classList.remove('show');
    updateHint();
  }

  function mini(txt){const b=document.createElement('button'); b.className='btn-mini'; b.textContent=txt; return b;}
  function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a;}

  function apply(r, animate=true){
    if(!animate){ r.strip.style.transition='none'; }
    const offset=(r.index - CENTER_ROW)*ROW_H;
    r.strip.style.transform=`translateY(${-offset}px)`;
    if(!animate){ requestAnimationFrame(()=>r.strip.style.transition=''); }
  }
  function applyAll(animate=true){ reels.forEach(r=>apply(r,animate)); }
  function nudge(r,dir){
    const L=r.loop.length;
    r.index=(r.index+dir+L)%L;
    apply(r); r.windowEl.classList.remove('stop'); void r.windowEl.offsetWidth; r.windowEl.classList.add('stop');
    updateHint(); checkWin();
  }
  function snapToIndex(r, loopIndex){
    r.index=loopIndex; apply(r); r.windowEl.classList.remove('stop'); void r.windowEl.offsetWidth; r.windowEl.classList.add('stop');
    checkWin(); updateHint();
  }
  function spin(r){ let steps=7+Math.floor(Math.random()*7), c=0; const t=setInterval(()=>{ nudge(r,1); if(++c>=steps){ clearInterval(t); checkWin(); } }, 90); }
  function spinAll(){ statusEl.textContent=""; statusEl.className="status"; infoBox.style.display="none"; winBanner.classList.remove('show'); let i=0; const next=()=>{ if(i>=reels.length){ setTimeout(checkWin,140); return; } spin(reels[i++]); setTimeout(next, 120); }; next(); }
  function centerItem(r){ const len=r.items.length; const idx=((r.index % len)+len)%len; return r.items[idx]; }

  function updateHint(){
    hintBtn.textContent = hintOn ? t().ui.hintOn : t().ui.hintOff;
    const keys=reels.map(r=>centerItem(r).key), counts={}; keys.forEach(k=>counts[k]=(counts[k]||0)+1);
    const best=Object.keys(counts).sort((a,b)=>counts[b]-counts[a])[0];
    const bestCount = best ? counts[best] : 0;
    reels.forEach(r=>r.payline.classList.toggle('almost', bestCount===4));
    if(!hintOn) return;
    if(!best){ hintBtn.textContent = t().ui.hintOn; return; }
    const toFix=[]; reels.forEach(r=>{ if(centerItem(r).key!==best){ const correct=r.items.find(it=>it.key===best)?.text || "‚Äî"; toFix.push(`${r.cat.label.replace(/^[^ ]+ /,'')}: ‚Äú${short(correct)}‚Äù`); }});
    hintBtn.textContent = toFix.length ? `${t().ui.hintOn} ‚Üí ${toFix.join("; ")}` : `${t().ui.hintOn} ‚Üí ${t().ui.looks}`;
  }
  function short(s){ return s.length>28 ? s.slice(0,25)+"‚Ä¶" : s; }

  function checkWin(){
    const keys=reels.map(r=>centerItem(r).key);
    const ok=keys.every(k=>k===keys[0]);
    if(!ok) return;
    const h = Object.values(H()).find(x=>x.key===keys[0]);
    statusEl.className="status success";
    statusEl.textContent = t().ui.win(h.name);
    revealInfo(h);
    celebrate();
    reels.forEach(r=>r.payline.classList.remove('almost'));
  }

  function celebrate(){
    winBanner.textContent = (LANG==='he') ? "üéâ ◊†◊ô◊¶◊ó◊ï◊ü! üéâ" : "üéâ YOU WIN! üéâ";
    winBanner.classList.add('show');
    setTimeout(()=>winBanner.classList.remove('show'), CELEBRATION_MS);
    confetti(CONFETTI_COUNT); jingle();
    document.querySelector('.machine').classList.add('win');
    setTimeout(()=>document.querySelector('.machine').classList.remove('win'), CELEBRATION_MS);
  }
  function confetti(n){
    for(let i=0;i<n;i++){
      const d=document.createElement('div'); d.className='confetti';
      d.style.left=(Math.random()*100)+"vw";
      d.style.background=`hsl(${Math.random()*360},85%,58%)`;
      document.body.appendChild(d);
      const dur=CELEBRATION_MS-600 + Math.random()*900, rot=360+Math.random()*720, end=105+Math.random()*10;
      d.animate([{transform:'translateY(0) rotate(0deg)'},{transform:`translateY(${end}vh) rotate(${rot}deg)`}],{duration:dur,easing:'cubic-bezier(.2,.8,.2,1)'});
      setTimeout(()=>d.remove(), dur+160);
    }
  }

  /* ---------- Prototype Media (no files) ---------- */
  function svgPoster(text,emoji,bg){
    const lang = (LANG==='he')?'he':'en';
    const dir  = (LANG==='he')?'rtl':'ltr';
    const safe = encodeURIComponent(
`<svg xmlns='http://www.w3.org/2000/svg' width='800' height='500' lang='${lang}'>
  <defs>
    <linearGradient id='g' x1='0' y1='0' x2='1' y2='1'>
      <stop offset='0%' stop-color='${bg}'/>
      <stop offset='100%' stop-color='#0a1130'/>
    </linearGradient>
  </defs>
  <rect width='100%' height='100%' fill='url(#g)' rx='24' ry='24'/>
  <text x='50%' y='58%' font-family='Segoe UI, Arial' font-size='64' font-weight='900' text-anchor='middle' fill='#ffffff' direction='${dir}'>${text}</text>
  <text x='50%' y='40%' font-size='120' text-anchor='middle'>${emoji}</text>
</svg>`);
    return `data:image/svg+xml;charset=utf-8,${safe}`;
  }

  function setMedia(h){
    posterImg.src = svgPoster(h.name, h.emoji, h.color);
    animBox.textContent = h.emoji.split('')[0] || 'üéâ';
    animBox.classList.add('bounce');
    btnPlay.onclick = ()=>playTheme(h.key);
    btnStop.onclick = stopAudio;
  }

  function revealInfo(h){
    document.getElementById('info-title').textContent=h.name;
    document.getElementById('i-story').textContent=h.story;
    document.getElementById('i-food').textContent=h.food;
    document.getElementById('i-season').textContent=h.season;
    document.getElementById('i-symbol').textContent=h.symbol;
    setMedia(h);
    infoBox.style.display="";
    infoBox.scrollIntoView({behavior:'smooth', block:'nearest'});
  }

  /* ---- Tiny WebAudio ‚Äútunes‚Äù per holiday (no files) ---- */
  function playTheme(key){
    stopAudio();
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    const now=audioCtx.currentTime;
    const scales={
      roshhashanah:[392,523,659,784],         // G4 C5 E5 G5
      yomkippur:[392,466,523,466,392],       // Minor-ish
      sukkot:[392,494,587,659,784],          // Bright
      simchattorah:[659,784,880,988],        // Dancing up
      hanukkah:[392,523,587,659,587,523],    // Simple ‚Äúfestival‚Äù
      purim:[392,440,494,523,494,440],       // Playful
      pesach:[392,523,587,523,392,330],      // Stepwise
      shavuot:[523,659,784,659,523]          // Ascent
    };
    const seq=scales[key]||[523,659,783,1046];
    seq.forEach((freq,i)=>{
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type='triangle'; o.frequency.value=freq; o.connect(g); g.connect(audioCtx.destination);
      const t=now+i*0.22;
      g.gain.setValueAtTime(0,t);
      g.gain.linearRampToValueAtTime(.45,t+.06);
      g.gain.exponentialRampToValueAtTime(.0001,t+.6);
      o.start(t); o.stop(t+.62);
      currentNodes.push(o,g);
    });
  }
  function stopAudio(){
    if(!audioCtx) return;
    try{ currentNodes.forEach(n=>n.stop?.()); }catch(e){}
    currentNodes=[]; try{ audioCtx.close(); }catch(e){}
    audioCtx=null;
  }

  function jingle(){ playTheme('sukkot'); } // reuse for win

  function celebrate(){
    winBanner.textContent = (LANG==='he') ? "üéâ ◊†◊ô◊¶◊ó◊ï◊ü! üéâ" : "üéâ YOU WIN! üéâ";
    winBanner.classList.add('show');
    setTimeout(()=>winBanner.classList.remove('show'), CELEBRATION_MS);
    confetti(CONFETTI_COUNT); jingle();
    document.querySelector('.machine').classList.add('win');
    setTimeout(()=>document.querySelector('.machine').classList.remove('win'), CELEBRATION_MS);
  }

  /* Controls */
  document.getElementById('lang-en').onclick=()=>{ LANG='en'; build(); };
  document.getElementById('lang-he').onclick=()=>{ LANG='he'; build(); };
  document.getElementById('btn-spin-all').onclick=spinAll;
  document.getElementById('btn-new').onclick=build;
  document.getElementById('lever').onclick=spinAll;
  document.getElementById('btn-hint').onclick=()=>{ hintOn=!hintOn; updateHint(); };

  function short(s){ return s.length>28 ? s.slice(0,25)+"‚Ä¶" : s; }
  window.addEventListener('DOMContentLoaded', build);
})();
</script>
</body>
</html>
